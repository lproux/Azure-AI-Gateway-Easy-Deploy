# Deployment Flow Diagram

## Visual Flow - Split Deployment Cells

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     NOTEBOOK EXECUTION                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Cell 0-10: Setup & Imports                                 â”‚
â”‚  âœ“ Install packages                                         â”‚
â”‚  âœ“ Import libraries                                         â”‚
â”‚  âœ“ Azure authentication                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Cell 11: Master Configuration                              â”‚
â”‚  deployment_name = 'master-lab-deployment'                  â”‚
â”‚  resource_group_name = 'lab-master-lab'                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
â”ƒ                 STEP 1: Check Deployment                   â”ƒ
â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Cell 13: Check if deployment exists                       â”‚
â”‚  az deployment group show --name ... -g ...                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
                    â”‚             â”‚
               YES  â”‚             â”‚  NO
    deployment_exists = True      deployment_exists = False
                    â”‚             â”‚
                    â”‚             â–¼
                    â”‚   â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
                    â”‚   â”ƒ  STEP 2: Create Resource Group  â”ƒ
                    â”‚   â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›
                    â”‚             â”‚
                    â”‚             â–¼
                    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   â”‚  Cell 15: Create RG             â”‚
                    â”‚   â”‚  az group create ...            â”‚
                    â”‚   â”‚  Location: uksouth              â”‚
                    â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚             â”‚
                    â”‚             â–¼
                    â”‚   â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
                    â”‚   â”ƒ  STEP 3: Deploy Infrastructure  â”ƒ
                    â”‚   â”ƒ  â±ï¸  30-45 MINUTES               â”ƒ
                    â”‚   â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›
                    â”‚             â”‚
                    â”‚             â–¼
                    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   â”‚  Cell 17: Deploy Bicep          â”‚
                    â”‚   â”‚  az deployment group create ... â”‚
                    â”‚   â”‚                                 â”‚
                    â”‚   â”‚  Deploys:                       â”‚
                    â”‚   â”‚  â€¢ APIM StandardV2              â”‚
                    â”‚   â”‚  â€¢ 3 AI Foundry hubs/projects   â”‚
                    â”‚   â”‚  â€¢ 14 AI models (UK South)      â”‚
                    â”‚   â”‚  â€¢ gpt-4o-mini (2 regions)      â”‚
                    â”‚   â”‚  â€¢ Redis Enterprise             â”‚
                    â”‚   â”‚  â€¢ Cognitive Search             â”‚
                    â”‚   â”‚  â€¢ Cosmos DB                    â”‚
                    â”‚   â”‚  â€¢ 7 MCP servers                â”‚
                    â”‚   â”‚  â€¢ Content Safety               â”‚
                    â”‚   â”‚                                 â”‚
                    â”‚   â”‚  ~60 resources total            â”‚
                    â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚             â”‚
                    â”‚       SUCCESS?
                    â”‚             â”‚
                    â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
                    â”‚      â”‚             â”‚
                    â”‚     YES            NO
                    â”‚      â”‚             â”‚
                    â”‚      â”‚             â–¼
                    â”‚      â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚      â”‚   â”‚  ERROR HANDLING     â”‚
                    â”‚      â”‚   â”‚  â€¢ Check Portal     â”‚
                    â”‚      â”‚   â”‚  â€¢ Fix issue        â”‚
                    â”‚      â”‚   â”‚  â€¢ Re-run Cell 17   â”‚
                    â”‚      â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚      â”‚             â”‚
                    â”‚      â”‚      FIX & RE-RUN
                    â”‚      â”‚             â”‚
                    â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚             â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
                    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
                    â”ƒ  STEP 4: Retrieve Outputs       â”ƒ
                    â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›
                                  â”‚
                                  â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Cell 19: Get deployment outputsâ”‚
                    â”‚  az deployment group show ...   â”‚
                    â”‚                                 â”‚
                    â”‚  Retrieves & defines:           â”‚
                    â”‚  â€¢ apim_gateway_url             â”‚
                    â”‚  â€¢ apim_service_id              â”‚
                    â”‚  â€¢ api_key                      â”‚
                    â”‚  â€¢ foundry_endpoint             â”‚
                    â”‚  â€¢ redis_host/port/key          â”‚
                    â”‚  â€¢ search_endpoint/key          â”‚
                    â”‚  â€¢ cosmos_endpoint              â”‚
                    â”‚  â€¢ mcp_servers[]                â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
                    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
                    â”ƒ  STEP 5: Export to .env         â”ƒ
                    â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›
                                  â”‚
                                  â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Cell 21: Create .env file      â”‚
                    â”‚                                 â”‚
                    â”‚  Creates:                       â”‚
                    â”‚  deployment-output.env          â”‚
                    â”‚                                 â”‚
                    â”‚  Contains all outputs for       â”‚
                    â”‚  reuse in other notebooks       â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
                    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
                    â”ƒ  âœ… SETUP COMPLETE!             â”ƒ
                    â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›
                                  â”‚
                                  â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Cell 22+: Run Lab Tests        â”‚
                    â”‚  All 31 labs ready!             â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Decision Tree

```
START
  â”‚
  â–¼
Does deployment exist? â”€â”€â”€â”€â”€â”€â”€â”€ YES â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º Skip to STEP 4
  â”‚
  NO
  â”‚
  â–¼
STEP 2: Create RG â”€â”€â”€â”€â”€â”€â”€â”€ ERROR? â”€â”€â”€â”€ YES â”€â–º Check permissions
  â”‚                                              â”‚
  OK                                             FIX
  â”‚                                              â”‚
  â–¼                                              â–¼
STEP 3: Deploy Bicep â”€â”€â”€â”€â”€â”€ ERROR? â”€â”€â”€â”€ YES â”€â–º Check:
  â”‚                                              â€¢ Quota
  â”‚                                              â€¢ Region
  â”‚                                              â€¢ Permissions
  â”‚                                              â”‚
  â”‚                                              FIX & RE-RUN
  â”‚                                              â”‚
  OK â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚
  â–¼
STEP 4: Retrieve Outputs â”€â”€â”€ ERROR? â”€â”€â”€â”€ YES â”€â–º Wait for deployment
  â”‚                                              â”‚
  OK                                             RE-RUN
  â”‚                                              â”‚
  â–¼ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
STEP 5: Export .env
  â”‚
  â–¼
DONE âœ…
```

---

## Time Breakdown

### First Run (No Deployment)
```
Cell 11:  Config                   ~1 sec
Cell 13:  Check status             ~2 sec
Cell 15:  Create RG                ~5 sec
Cell 17:  Deploy Bicep         ğŸ• 30-45 min  â¬…ï¸ LONG
Cell 19:  Retrieve outputs         ~3 sec
Cell 21:  Export .env              ~1 sec
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Total:                             ~30-45 min
```

### Subsequent Runs (Deployment Exists)
```
Cell 11:  Config                   ~1 sec
Cell 13:  Check status             ~2 sec
(Skip 15) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    ~0 sec
(Skip 17) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    ~0 sec
Cell 19:  Retrieve outputs         ~3 sec
Cell 21:  Export .env              ~1 sec
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Total:                             ~7 sec  âš¡ FAST
```

---

## Error Recovery Paths

### Scenario: Deployment Fails at Step 3

```
Cell 17: Deploy Bicep
  â”‚
  â–¼
âŒ ERROR: QuotaExceeded
  â”‚
  â–¼
[User Action]
1. Check Azure Portal
2. Request quota increase
   OR
   Edit master-deployment.bicep to reduce models
  â”‚
  â–¼
Re-run Cell 17 only
  â”‚
  â–¼
âœ… SUCCESS
  â”‚
  â–¼
Continue to Cell 19
```

### Scenario: Want Fresh Deployment

```
[User Action]
Delete resource group:
az group delete --name lab-master-lab --yes
  â”‚
  â–¼
Re-run from Cell 13
  â”‚
  â–¼
Cell 13: deployment_exists = False
  â”‚
  â–¼
Continue through all steps:
13 â†’ 15 â†’ 17 â†’ 19 â†’ 21
```

---

## Parallel Comparison

### Old Approach (Single Cell)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Cell 13: Do Everything        â”‚
â”‚  â€¢ Check deployment            â”‚
â”‚  â€¢ Create RG                   â”‚
â”‚  â€¢ Deploy Bicep (30-45 min)    â”‚
â”‚  â€¢ Retrieve outputs            â”‚
â”‚  â€¢ Export .env                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
   âŒ ERROR at Deploy?
         â”‚
         â–¼
   Start ALL OVER
   (can't resume)
```

### New Approach (Split Cells)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Cell 13     â”‚ â†’ â”‚  Cell 15     â”‚ â†’ â”‚  Cell 17     â”‚ â†’ â”‚  Cell 19     â”‚ â†’ â”‚  Cell 21     â”‚
â”‚  Check       â”‚   â”‚  Create RG   â”‚   â”‚  Deploy      â”‚   â”‚  Retrieve    â”‚   â”‚  Export      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                            â”‚
                                            â–¼
                                      âŒ ERROR at Deploy?
                                            â”‚
                                            â–¼
                                      Fix & RE-RUN Cell 17 only
                                            â”‚
                                            â–¼
                                      âœ… Continue to Cell 19
                                      (resume where left off)
```

---

## Cell Dependencies

```
Cell 11 â”€â”€â”€â–º Sets: deployment_name, resource_group_name
              â”‚
              â–¼
Cell 13 â”€â”€â”€â–º Sets: deployment_exists (bool)
              â”‚
              â”œâ”€â–º Cell 15 (needs: deployment_exists, resource_group_name)
              â”‚
              â”œâ”€â–º Cell 17 (needs: deployment_exists, deployment_name, resource_group_name)
              â”‚             Sets: deployment_exists = True on success
              â”‚
              â–¼
Cell 19 â”€â”€â”€â–º Needs: deployment_name, resource_group_name
              Sets: apim_gateway_url, api_key, redis_*, search_*, cosmos_*, mcp_servers
              â”‚
              â–¼
Cell 21 â”€â”€â”€â–º Needs: ALL variables from Cell 19
              Creates: deployment-output.env
```

---

## Summary

### âœ… Benefits of Split Approach

1. **Debuggable**: See exactly which step failed
2. **Resumable**: Re-run just the failed cell
3. **Inspectable**: Check Azure Portal between steps
4. **Flexible**: Skip steps if deployment exists
5. **Clear**: Visual progress through 5 steps

### ğŸ¯ Still "One-Click"

- First run: Just run cells sequentially (13 â†’ 15 â†’ 17 â†’ 19 â†’ 21)
- Subsequent runs: Even faster (13 â†’ 19 â†’ 21)
- Smart logic handles everything automatically

### ğŸ“Š Result

**Best of both worlds**: Easy to use + Easy to debug!
