import requests, os, subprocess, json, timeapim_url = os.getenv('APIM_GATEWAY_URL')endpoint = f"{apim_url}/inference/openai/deployments/gpt-4o-mini/chat/completions?api-version=2024-08-01-preview"print("" + "="*80)print("üìä TEST: JWT Only Authentication")print("="*80 + "")# Get JWT token using Azure CLI (resolved path from Cell 5)az_cli = os.environ.get('AZ_CLI', 'az')print(f"[1] Using Azure CLI: {az_cli}")try:    print(f"[2] Acquiring JWT token for scope: https://cognitiveservices.azure.com")        result = subprocess.run(        [az_cli, 'account', 'get-access-token', '--resource', 'https://cognitiveservices.azure.com'],        capture_output=True, text=True, timeout=30    )        if result.returncode != 0:        print("‚ö†Ô∏è  ERROR: Cannot get JWT token")        print("Please run: az login")        print(f"Error: {result.stderr}")    else:        token_data = json.loads(result.stdout)        jwt_token = token_data['accessToken']                print(f"[3] ‚úì JWT token acquired successfully")        print(f"    Token length: {len(jwt_token)} characters")        print(f"    Token preview: {jwt_token[:50]}...")        print(f"    Expires: {token_data.get('expiresOn', 'unknown')}")                print(f"[4] Sending request to APIM endpoint")        print(f"    URL: {endpoint}")        print(f"    Header: Authorization: Bearer <token>")                # Test: JWT authentication        response = requests.post(            endpoint,            headers={"Authorization": f"Bearer {jwt_token}"},            json={"messages": [{"role": "user", "content": "Hello"}], "max_tokens": 10},            timeout=30        )                print(f"[5] Response received")        print(f"    Status: {response.status_code} - Expected: 200")                if response.status_code == 200:            print(f"‚úì PASS - JWT authentication working!")            try:                resp_json = response.json()                content = resp_json.get('choices', [{}])[0].get('message', {}).get('content', '')                print(f"    Response: {content[:100]}")            except:                print(f"    Response: {response.text[:100]}")        else:            print(f"‚úó FAIL - JWT authentication failed")            print(f"[ERROR DETAILS]")            print(f"Status Code: {response.status_code}")            print(f"Response Headers: {dict(response.headers)}")            print(f"Response Body:")            try:                print(json.dumps(response.json(), indent=2))            except:                print(response.text)                except FileNotFoundError:    print("‚ö†Ô∏è  ERROR: Azure CLI not found")    print(f"Expected path: {az_cli}")    print("Please ensure Cell 5 ran successfully")    print("Or install Azure CLI: https://learn.microsoft.com/cli/azure/install-azure-cli")except Exception as e:    print(f"‚ö†Ô∏è  ERROR: {str(e)}")print("" + "="*80 + "")