import requests, os, subprocess, json

apim_url = os.getenv('APIM_GATEWAY_URL')
endpoint = f"{apim_url}/inference/openai/deployments/gpt-4o-mini/chat/completions?api-version=2024-08-01-preview"

# Get JWT token using Azure CLI (resolved path from Cell 5)
az_cli = os.environ.get('AZ_CLI', 'az')

try:
    result = subprocess.run(
        [az_cli, 'account', 'get-access-token', '--resource', 'https://cognitiveservices.azure.com'],
        capture_output=True, text=True, timeout=30
    )
    
    if result.returncode != 0:
        print("\n‚ö†Ô∏è  ERROR: Cannot get JWT token")
        print("Please run: az login")
        print(f"Error: {result.stderr}")
    else:
        token_data = json.loads(result.stdout)
        jwt_token = token_data['accessToken']
        
        # Test: JWT authentication
        response = requests.post(
            endpoint,
            headers={"Authorization": f"Bearer {jwt_token}"},
            json={"messages": [{"role": "user", "content": "Hello"}], "max_tokens": 10},
            timeout=30
        )
        
        print(f"\nüìä Test: JWT Only")
        print(f"Status: {response.status_code} - Expected: 200")
        print(f"Result: {'‚úì PASS - JWT auth working' if response.status_code == 200 else '‚úó FAIL'}\n")
        
        if response.status_code != 200:
            print(f"Response: {response.text[:200]}")
            
except FileNotFoundError:
    print("\n‚ö†Ô∏è  ERROR: Azure CLI not found")
    print(f"Expected path: {az_cli}")
    print("Please ensure Cell 5 ran successfully")
    print("Or install Azure CLI: https://learn.microsoft.com/cli/azure/install-azure-cli")
except Exception as e:
    print(f"\n‚ö†Ô∏è  ERROR: {str(e)}")
