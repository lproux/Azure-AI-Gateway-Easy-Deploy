import requests, os, subprocess, time
from azure.identity import DefaultAzureCredential

credential = DefaultAzureCredential()
token = credential.get_token("https://management.azure.com/.default")

# Configuration
subscription_id = os.environ.get('SUBSCRIPTION_ID')
resource_group = os.environ.get('RESOURCE_GROUP')
apim_service_name = os.environ.get('APIM_SERVICE_NAME')
api_id = os.environ.get('APIM_API_ID', 'inference-api')

# Get tenant ID
az_cli = os.environ.get('AZ_CLI', 'az')
result = subprocess.run(
    [az_cli, 'account', 'show', '--query', 'tenantId', '-o', 'tsv'],
    capture_output=True, text=True, timeout=10
)
tenant_id = result.stdout.strip() if result.returncode == 0 else os.environ.get('AZURE_TENANT_ID', '')

if not tenant_id:
    print("[ERROR] Cannot resolve tenant ID")
else:
    print(f"[auth] Resolved tenant_id: {tenant_id}")
    
    # Dual Auth policy (JWT + API Key)
    policy_xml = f"""<policies>
        <inbound>
            <base />
            <validate-jwt header-name="Authorization" failed-validation-httpcode="401" require-expiration-time="true" require-signed-tokens="true">
                <openid-config url="https://login.microsoftonline.com/{tenant_id}/v2.0/.well-known/openid-configuration" />
                <audiences><audience>https://cognitiveservices.azure.com</audience></audiences>
            </validate-jwt>
            <check-header name="api-key" failed-check-httpcode="401" failed-check-error-message="Missing API key" />
            <set-backend-service backend-id="inference-backend-pool" />
        </inbound>
        <backend><base /></backend>
        <outbound><base /></outbound>
        <on-error><base /></on-error>
    </policies>"""
    
    # Apply policy using direct REST API
    try:
        url = f"https://management.azure.com/subscriptions/{subscription_id}/resourceGroups/{resource_group}/providers/Microsoft.ApiManagement/service/{apim_service_name}/apis/{api_id}/policies/policy?api-version=2022-08-01"
        
        headers = {
            "Authorization": f"Bearer {token.token}",
            "Content-Type": "application/json"
        }
        
        body = {
            "properties": {
                "value": policy_xml,
                "format": "xml"
            }
        }
        
        response = requests.put(url, headers=headers, json=body, timeout=60)
        
        print(f"\nüìù Policy Applied: Dual Auth (JWT + API Key)")
        print(f"Status: {response.status_code} - {'‚úì SUCCESS' if response.status_code in [200, 201] else '‚úó FAILED'}")
        
        if response.status_code not in [200, 201]:
            print(f"Error: {response.text[:500]}")
        else:
            # Verify policy was applied (handle BOM in response)
            print("\n[VERIFY] Checking if policy was applied...")
            try:
                verify_response = requests.get(url, headers=headers, timeout=30)
                if verify_response.status_code == 200:
                    # Remove BOM if present
                    response_text = verify_response.text
                    if response_text.startswith('\ufeff'):
                        response_text = response_text[1:]
                    
                    policy_content = json.loads(response_text)
                    applied_xml = policy_content.get('properties', {}).get('value', '')
                    
                    if 'validate-jwt' in applied_xml and 'check-header' in applied_xml:
                        print("[VERIFY] ‚úì Dual auth policy is active (JWT + api-key)")
                    else:
                        print("[VERIFY] ‚úó WARNING: Policy verification failed!")
                else:
                    print(f"[VERIFY] Failed to read policy: {verify_response.status_code}")
            except Exception as verify_error:
                print(f"[VERIFY] Error during verification: {str(verify_error)[:200]}")
                print("[VERIFY] Policy may still have been applied - proceeding with wait")
                    
            print("\n‚è≥ Waiting 60 seconds for policy to propagate...")
            for i in range(60, 0, -1):
                print(f"   {i} seconds remaining...", end='\r')
                time.sleep(1)
            print("\n‚úì Policy propagation complete!\n")
    except Exception as e:
        print(f"\n[ERROR] {str(e)}")
