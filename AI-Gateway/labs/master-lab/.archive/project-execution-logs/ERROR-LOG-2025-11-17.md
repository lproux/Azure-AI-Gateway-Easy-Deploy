# Error Log - Phase 2 Debugging
**Date**: 2025-11-17
**Session**: Current - User Documented Errors
**Notebook**: master-ai-gateway-fix-MCP.ipynb (171 cells)
**Status**: COMPREHENSIVE ERROR CATALOG

---

## Error Summary

| Severity | Count | Description |
|----------|-------|-------------|
| **CRITICAL** | 6 | Blocking core functionality |
| **HIGH** | 6 | Major features broken |
| **MEDIUM** | 4 | Missing features/outdated code |
| **LOW** | 1 | Package dependency |
| **WARNING** | 4 | Working but suboptimal |
| **TOTAL** | **21** | **Documented errors** |

---

## CRITICAL ERRORS (6)

### Cell 45: Load Balancing Not Working ‚ùå
**Severity**: CRITICAL
**Category**: Infrastructure/APIM Policy
**Error**: Load balancing policy applied but all requests going to single region (UK South 100%)
**Output**:
```
Testing load balancing across 3 regions...
Request 1-5: Region: UK South - Backend: Unknown (100%)
Average response time: 0.78s
```

**Root Cause**: 
- Backend pool not distributing requests
- Policy may not be correctly configured
- Backend detection logic may be broken

**Impact**: No geographic distribution, single point of failure
**Dependencies**: APIM backend pool configuration

**Fix Strategy**:
1. Verify APIM backend pool has all 3 regions (foundry1, foundry2, foundry3)
2. Check backend-pool-load-balancing policy is correctly applied
3. Verify response headers contain region information
4. Test backend health individually

**Testing Protocol**: Full A-L protocol required
**Cross-Reference**: Cell 43 (Warning - policy applied)

---

### Cell 63: Model Routing - Missing gpt-4.1-mini ‚ùå
**Severity**: CRITICAL
**Category**: Model Deployment
**Error**: Model gpt-4.1-mini should be deployed but is being skipped
**Output**:
```
[routing] Skipping unavailable models: gpt-4.1-mini
[*] Testing model: gpt-4o-mini
Model gpt-4o-mini: Hello! How can I assist you today?
```

**Root Cause**:
- gpt-4.1-mini not deployed to any foundry
- Model routing expecting 2 models but only 1 available

**Impact**: Model routing feature incomplete, missing failover capability
**Dependencies**: Azure AI Foundry model deployment

**Fix Strategy**:
1. Update Cell 29 models_config to deploy gpt-4.1-mini OR
2. Update Cell 63 to use only gpt-4o-mini (remove gpt-4.1-mini expectation)
3. Redeploy models to foundry1/2/3
4. Verify model availability in Azure portal

**Testing Protocol**: Full A-L protocol required

---

### Cell 78: Excel File Read Failure (BadZipFile) ‚ùå
**Severity**: CRITICAL
**Category**: File I/O / Data Processing
**Error**: `zipfile.BadZipFile: File is not a zip file`
**Traceback**:
```python
File "pandas\io\excel\_openpyxl.py", line 95, in _validate_archive
    archive = ZipFile(filename, 'r')
zipfile.BadZipFile: File is not a zip file
```

**Root Cause**:
- Excel file path points to non-existent or corrupted file
- File might be CSV format but trying to read as Excel
- Sample data not properly created/available

**Impact**: Exercise 2.1 (MCP Data + AI) completely broken
**Dependencies**: Sample data files in `sample-data/` folder

**Fix Strategy**:
1. Check if file exists at path: `sample-data/regional-sales-data.xlsx`
2. Verify file is valid Excel format (.xlsx)
3. Consider using CSV alternative (referenced in user note about route-a-automated workshop)
4. Create sample Excel file if missing
5. Update openpyxl package if needed

**Testing Protocol**: Full A-L protocol required
**User Note**: Check previous workshop at `C:\Users\lproux\...\workshop\route-a-automated`

---

### Cell 80: Excel File Read Failure (Duplicate) ‚ùå
**Severity**: CRITICAL
**Category**: File I/O / Data Processing
**Error**: Same `zipfile.BadZipFile` error as Cell 78
**Output**: Same error traceback

**Root Cause**: Same as Cell 78
**Impact**: Exercise 2.2 (Sales Analysis via MCP + AI) completely broken
**Fix Strategy**: Same as Cell 78 - fix Excel file issue globally

---

### Cell 83: Excel File Read Failure (Duplicate) ‚ùå
**Severity**: CRITICAL
**Category**: File I/O / Data Processing
**Error**: Same `zipfile.BadZipFile` error as Cell 78
**File**: `sample-data/azure-cost-data.xlsx`

**Root Cause**: Same as Cell 78
**Impact**: Exercise 2.3 (Azure Cost Analysis via MCP) completely broken
**Fix Strategy**: Same as Cell 78 - fix all Excel sample data files

---

### Cell 155: Missing Environment Variables ‚ùå
**Severity**: CRITICAL
**Category**: Configuration
**Error**: `RuntimeError: Missing variables: ['APIM_GATEWAY_URL']`
**Output**:
```python
RuntimeError: Missing variables: ['APIM_GATEWAY_URL']
```

**Root Cause**:
- Cell expects environment variables not loaded
- Possibly outdated variable names or missing .env loading

**Impact**: Lab 22 (Image Generation) and subsequent labs broken
**Dependencies**: Environment variable loading (Cell 3)

**Fix Strategy**:
1. Verify Cell 3 loads all required variables
2. Check if APIM_GATEWAY_URL should be `apim_gateway_url` (lowercase)
3. Update Cell 155 to use correct variable names
4. Add fallback to read from master-lab.env

**Testing Protocol**: Full A-L protocol required

---

## HIGH PRIORITY ERRORS (6)

### Cell 85: MCP Docs Server TaskGroup Exception ‚ö†Ô∏è
**Severity**: HIGH
**Category**: MCP Integration
**Error**: `ExceptionGroup: KeyError: 0`
**Output**:
```python
ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-- KeyError: 0
```

**Root Cause**:
- MCP docs server response format mismatch
- Helper code expecting different API structure
- Index access error in response parsing

**Impact**: MCP Docs integration (Exercise 2.4) broken
**Dependencies**: Docs MCP server at `http://docs-mcp-24774.eastus.azurecontainer.io:8000/mcp`

**Fix Strategy**:
1. Test docs MCP server endpoint directly
2. Inspect actual response structure
3. Update `notebook_mcp_helpers.py` to handle correct format
4. Add error handling for missing fields/indices

**Testing Protocol**: Full A-L protocol required

---

### Cell 93: Semantic Kernel - Missing Positional Argument ‚ö†Ô∏è
**Severity**: HIGH
**Category**: Framework Integration
**Error**: `TypeError: ChatCompletionClientBase.get_chat_message_contents() missing 1 required positional argument: 'settings'`

**Root Cause**:
- Semantic Kernel API changed
- Incorrect method call signature
- Missing settings parameter

**Impact**: Semantic Kernel testing (Technique 2) fails
**Dependencies**: semantic-kernel==1.37.0

**Fix Strategy**:
1. Update SK method calls to include `settings` parameter
2. Use `PromptExecutionSettings` class
3. Reference SK 1.37.0 documentation for correct API
4. Test with simple prompt first

**Testing Protocol**: Full A-L protocol required
**User Requirement**: 1 working Semantic Kernel example needed

---

### Cell 97: Semantic Kernel - Kernel.arguments AttributeError ‚ö†Ô∏è
**Severity**: HIGH
**Category**: Framework Integration
**Error**: `AttributeError: 'Kernel' object has no attribute 'arguments'`

**Root Cause**:
- Kernel API changed in SK 1.37.0
- `kernel.arguments` no longer exists
- Need to use different approach for passing arguments

**Impact**: Technique 15 (Hybrid Approach) fails
**Dependencies**: semantic-kernel==1.37.0

**Fix Strategy**:
1. Remove `kernel.arguments` reference
2. Use `KernelArguments` class directly
3. Update to SK 1.37.0 API patterns
4. Test alternative argument passing methods

**Testing Protocol**: Full A-L protocol required

---

### Cell 99: AutoGen + APIM Integration Failure ‚ö†Ô∏è
**Severity**: HIGH
**Category**: Framework Integration / MCP
**Error**: `ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)`
**Output**:
```
Example 1 failed: unhandled errors in a TaskGroup (1 sub-exception)
```

**Root Cause**:
- MCP server connection failure through APIM
- SSE transport issue
- Timeout or connectivity problem

**Impact**: AutoGen production solution (Cell 99) not working
**Dependencies**: Weather MCP server, APIM SSE endpoint

**Fix Strategy**:
1. Test MCP SSE endpoint directly: `{apim_resource_gateway_url}/weather/sse`
2. Verify APIM policies allow SSE traffic
3. Check MCP server is running and accessible
4. Add better error handling and logging
5. Test with working MCP server (Excel or Docs)

**Testing Protocol**: Full A-L protocol required
**User Requirement**: 1 working AutoGen example needed

---

### Cell 104: Semantic Kernel - Dict AttributeError ‚ö†Ô∏è
**Severity**: HIGH
**Category**: Framework Integration
**Error**: `AttributeError: 'dict' object has no attribute 'pack_extension_data'`

**Root Cause**:
- Passing plain dict instead of `PromptExecutionSettings` object
- SK 1.37.0 requires typed settings objects

**Impact**: Semantic Kernel testing suite fails
**Dependencies**: semantic-kernel==1.37.0

**Fix Strategy**:
1. Replace dict with `AzureChatPromptExecutionSettings` object
2. Example:
```python
from semantic_kernel.connectors.ai.open_ai import AzureChatPromptExecutionSettings
settings = AzureChatPromptExecutionSettings(max_tokens=100, temperature=0.7)
```
3. Update all SK method calls to use typed settings

**Testing Protocol**: Full A-L protocol required

---

### Cell 106: Semantic Kernel Diagnostic - Multiple Failures ‚ö†Ô∏è
**Severity**: HIGH
**Category**: Diagnostic / Configuration
**Errors**:
1. Azure OpenAI: `NotFoundError: 404 - Resource not found`
2. SK test: `TypeError: Kernel.invoke_prompt() missing 1 required positional argument: 'prompt'`

**Root Cause**:
- Diagnostic code using wrong Azure OpenAI endpoint format
- SK API calls outdated
- MCP servers returning 401/404

**Impact**: Cannot diagnose SK issues properly
**Dependencies**: All SK/APIM/MCP infrastructure

**Fix Strategy**:
1. Fix Azure OpenAI client to use correct endpoint:
   - Should be: `{apim_gateway_url}/inference-api`
   - Not: base `apim_gateway_url`
2. Update `kernel.invoke_prompt()` calls to SK 1.37.0 API
3. Update MCP health checks (401 is auth issue, 404 is endpoint issue)
4. This cell needs complete rewrite for SK 1.37.0

**Testing Protocol**: Full A-L protocol required

---

## MEDIUM PRIORITY ERRORS (4)

### Cell 29: Model Deployment - Invalid SKU for DALL-E-3 ‚ö†Ô∏è
**Severity**: MEDIUM
**Category**: Model Deployment Configuration
**Error**: `(InvalidResourceProperties) The specified SKU 'Standard' for model 'dall-e-3 3.0'`
**Output**:
```
[SKIP] dall-e-3 failed: (InvalidResourceProperties) The specified SKU 'Standard' for model 'dall-e-3 3.0
```

**Root Cause**:
- Wrong SKU specified for DALL-E-3
- Should use different SKU (not "Standard")

**Impact**: Image generation features unavailable
**Dependencies**: Azure OpenAI model deployment

**Fix Required**:
```python
# INCORRECT
{'name': 'dall-e-3', 'format': 'OpenAI', 'version': '3.0', 'sku': 'Standard', 'capacity': 1}

# CORRECT (need to verify correct SKU)
{'name': 'dall-e-3', 'format': 'OpenAI', 'version': '3.0', 'sku': 'GlobalStandard', 'capacity': 1}
```

**Fix Strategy**:
1. Check Azure documentation for correct DALL-E-3 SKU
2. Update models_config in Cell 29
3. Redeploy model
4. Verify in Azure portal

**Testing Protocol**: Deploy and verify
**Also Needed**: Add gpt-4.1-mini to same config

---

### Cell 95: MCP Server Returns 404 ‚ö†Ô∏è
**Severity**: MEDIUM
**Category**: MCP Connectivity
**Error**: MCP server connected but returns 404 status
**Output**:
```
‚úÖ MCP Server responding
üì° Status Code: 404
```

**Root Cause**:
- Testing root endpoint instead of `/mcp` path
- Docs MCP server expects specific path

**Impact**: Diagnostic misleading - shows connected but endpoint wrong
**Dependencies**: Docs MCP server

**Fix Strategy**:
1. Update endpoint to: `http://docs-mcp-master.eastus.azurecontainer.io:8000/mcp`
2. Not just: `http://docs-mcp-master.eastus.azurecontainer.io:8000`
3. Update all MCP endpoint tests consistently

**Testing Protocol**: Simple HTTP test

---

### Cell 108: Semantic Cache Not Working + Client Undefined ‚ö†Ô∏è
**Severity**: MEDIUM
**Category**: Caching / Client Initialization
**Errors**:
1. Semantic cache not showing any cache hits
2. Client initialization warning

**Output**:
```
[WARN] Cannot init client (missing: apim_gateway_url, inference_api_path, apim_api_key). Skipping requests.
```

**Root Cause**:
- Variables not loaded properly
- Semantic cache policy may not be active
- Client initialization logic has issues

**Impact**: Lab 19 (Semantic Caching) not demonstrating caching
**Dependencies**: APIM semantic cache policy

**Fix Strategy**:
1. Fix client initialization - ensure variables loaded
2. Verify semantic cache policy is active (Cell 17)
3. Test with identical queries to trigger cache
4. Check APIM cache headers in response

**Testing Protocol**: Full A-L protocol required
**Cross-Reference**: Cell 17 (Warning - cache policy applied)

---

### Cell 119+: Outdated Code ‚ö†Ô∏è
**Severity**: MEDIUM
**Category**: Code Maintenance
**Error**: Multiple cells from 119 onwards are outdated

**Root Cause**:
- Code not updated after infrastructure changes
- Variable names changed
- APIs updated

**Impact**: Unknown - cells not tested yet
**Dependencies**: All infrastructure

**Fix Strategy**:
1. Review cells 119-171 systematically
2. Update variable names
3. Update API calls
4. Test each cell sequentially

**Testing Protocol**: Full A-L protocol for each cell
**User Note**: Need to actualize all these cells

---

## LOW PRIORITY ERRORS (1)

### Cell 15: Missing openpyxl in requirements ‚ö†Ô∏è
**Severity**: LOW
**Category**: Package Dependency
**Error**: Warning about openpyxl during pip install
**Output**: Package already installed

**Root Cause**:
- openpyxl not in requirements.txt (but already installed globally)

**Impact**: None currently (package installed)
**Dependencies**: requirements.txt

**Fix Strategy**:
1. Add `openpyxl>=3.1.0` to requirements.txt
2. Verify in Cell 15
3. No urgent action needed (already working)

**Testing Protocol**: None needed

---

## WARNING ERRORS (4)

### Cell 17: Semantic Cache Policy Applied But Not Working ‚ö†Ô∏è
**Severity**: WARNING
**Category**: APIM Policy Configuration
**Status**: Policy applied successfully (200 OK) but cache not functioning
**Output**:
```
[OK] Policy application complete
[INFO] Policy will take ~30-60 seconds to propagate
```

**Root Cause**:
- Policy applied but not working in practice
- May need propagation time
- May need specific request patterns

**Impact**: Medium - caching feature not demonstrating value
**Dependencies**: APIM semantic cache policy, Azure OpenAI backend

**Fix Strategy**:
1. Wait 60 seconds after policy application
2. Test with identical requests
3. Check APIM cache headers in responses
4. Verify policy is actually active in APIM portal

**Testing Protocol**: Wait + test
**Cross-Reference**: Cell 108 (Medium - cache not working)

---

### Cell 43: Load Balancing Policy Applied But Not Working ‚ö†Ô∏è
**Severity**: WARNING
**Category**: APIM Policy Configuration
**Status**: Policy applied successfully but load balancing not functioning
**Output**: Same as Cell 29 deployment output

**Root Cause**:
- Policy applied but not routing to multiple backends
- Backend pool configuration issue

**Impact**: High - no geographic distribution
**Dependencies**: APIM backend pool

**Fix Strategy**:
1. Verify backend pool has all 3 foundries
2. Check backend health status
3. Verify policy routing logic
4. Test backend responses individually

**Testing Protocol**: Full A-L protocol required
**Cross-Reference**: Cell 45 (Critical - load balancing not working)

---

### Cell 47: Load Balancing Visualization ‚ö†Ô∏è
**Severity**: WARNING
**Category**: Visualization / Data Processing
**Status**: Related to Cell 45 - showing all requests to one region

**Root Cause**: Same as Cell 45
**Impact**: Visualization shows incorrect distribution
**Dependencies**: Load balancing functionality

**Fix Strategy**: Fix Cell 45 first, then this will work
**Testing Protocol**: After Cell 45 fixed

---

### Cell 63: Model Routing Using Only 1 Model ‚ö†Ô∏è
**Severity**: WARNING  
**Category**: Model Deployment
**Status**: Working but only testing 1 model instead of 2

**Root Cause**: gpt-4.1-mini not deployed
**Impact**: Model routing not fully tested
**Dependencies**: Model deployment

**Fix Strategy**: Deploy gpt-4.1-mini or update cell to use 2 available models
**Testing Protocol**: After model deployment
**Cross-Reference**: Cell 29 (Medium - need to add gpt-4.1-mini)

---

## Error Dependencies Map

```
Cell 29 (Model Config)
  ‚îú‚îÄ‚îÄ Cell 63 (Model Routing) - CRITICAL
  ‚îú‚îÄ‚îÄ Cell 155+ (Image Generation) - MEDIUM
  ‚îî‚îÄ‚îÄ Cell 106 (SK Diagnostic) - via Azure OpenAI

Cell 43 (LB Policy Applied)
  ‚îî‚îÄ‚îÄ Cell 45 (LB Not Working) - CRITICAL
      ‚îî‚îÄ‚îÄ Cell 47 (LB Visualization) - WARNING

Cell 17 (Cache Policy Applied)
  ‚îî‚îÄ‚îÄ Cell 108 (Cache Not Working) - MEDIUM

Cell 78 (Excel Error)
  ‚îú‚îÄ‚îÄ Cell 80 (Same Error) - CRITICAL
  ‚îî‚îÄ‚îÄ Cell 83 (Same Error) - CRITICAL

Cell 85 (MCP Docs Error)
  ‚îî‚îÄ‚îÄ Cell 95 (MCP 404) - MEDIUM

Cell 93 (SK Error)
  ‚îú‚îÄ‚îÄ Cell 97 (SK Error) - HIGH
  ‚îú‚îÄ‚îÄ Cell 104 (SK Error) - HIGH
  ‚îî‚îÄ‚îÄ Cell 106 (SK Diagnostic) - HIGH

Cell 99 (AutoGen Error)
  ‚îî‚îÄ‚îÄ Needs working MCP server

Cell 119+ (Outdated)
  ‚îî‚îÄ‚îÄ All subsequent cells - MEDIUM
```

---

## Fix Priority Order

### IMMEDIATE (Critical - Blocking)
1. **Cell 78, 80, 83**: Excel file issues (3 cells, same root cause)
   - Impact: 3 MCP exercises completely broken
   - Fix: Create/fix sample Excel files OR convert to CSV
   - Time: 30 minutes

2. **Cell 45**: Load balancing not working
   - Impact: Geographic distribution broken
   - Fix: APIM backend pool configuration
   - Time: 45 minutes

3. **Cell 155**: Missing environment variables
   - Impact: Image generation and subsequent labs broken
   - Fix: Update variable names/loading
   - Time: 15 minutes

### HIGH PRIORITY (Major Features)
4. **Cell 93, 97, 104, 106**: Semantic Kernel API updates
   - Impact: All SK examples broken
   - Fix: Update to SK 1.37.0 API
   - Time: 2 hours (need to update multiple cells)

5. **Cell 99**: AutoGen + APIM integration
   - Impact: AutoGen production example broken
   - Fix: Fix MCP SSE connection
   - Time: 1 hour

6. **Cell 85**: MCP Docs server error
   - Impact: MCP Docs exercise broken
   - Fix: Update response parsing
   - Time: 30 minutes

### MEDIUM PRIORITY (Missing Features)
7. **Cell 29**: Model deployment (DALL-E-3 SKU, gpt-4.1-mini)
   - Impact: Image gen + model routing incomplete
   - Fix: Update config and redeploy
   - Time: 45 minutes

8. **Cell 108**: Semantic cache not working
   - Impact: Cache demo not working
   - Fix: Fix client init + verify policy
   - Time: 30 minutes

9. **Cell 119+**: Outdated code
   - Impact: Unknown until tested
   - Fix: Systematic review and update
   - Time: 2-3 hours

### LOW PRIORITY
10. **Cell 15**: Add openpyxl to requirements
    - Impact: None (already installed)
    - Fix: Add line to requirements.txt
    - Time: 2 minutes

---

## Testing Status Tracker

| Cell | Error | Severity | Tested | Fixed | Verified |
|------|-------|----------|--------|-------|----------|
| 15 | Missing openpyxl | LOW | ‚úÖ | ‚ùå | ‚ùå |
| 17 | Cache policy | WARNING | ‚úÖ | ‚ùå | ‚ùå |
| 29 | Model SKU | MEDIUM | ‚úÖ | ‚ùå | ‚ùå |
| 43 | LB policy | WARNING | ‚úÖ | ‚ùå | ‚ùå |
| 45 | LB not working | CRITICAL | ‚úÖ | ‚ùå | ‚ùå |
| 47 | LB viz | WARNING | ‚úÖ | ‚ùå | ‚ùå |
| 63 | Model routing | CRITICAL | ‚úÖ | ‚ùå | ‚ùå |
| 78 | Excel error | CRITICAL | ‚úÖ | ‚ùå | ‚ùå |
| 80 | Excel error | CRITICAL | ‚úÖ | ‚ùå | ‚ùå |
| 83 | Excel error | CRITICAL | ‚úÖ | ‚ùå | ‚ùå |
| 85 | MCP Docs | HIGH | ‚úÖ | ‚ùå | ‚ùå |
| 93 | SK API | HIGH | ‚úÖ | ‚ùå | ‚ùå |
| 95 | MCP 404 | MEDIUM | ‚úÖ | ‚ùå | ‚ùå |
| 97 | SK API | HIGH | ‚úÖ | ‚ùå | ‚ùå |
| 99 | AutoGen | HIGH | ‚úÖ | ‚ùå | ‚ùå |
| 104 | SK API | HIGH | ‚úÖ | ‚ùå | ‚ùå |
| 106 | SK diagnostic | HIGH | ‚úÖ | ‚ùå | ‚ùå |
| 108 | Cache not working | MEDIUM | ‚úÖ | ‚ùå | ‚ùå |
| 119+ | Outdated | MEDIUM | ‚ùå | ‚ùå | ‚ùå |
| 155 | Env vars | CRITICAL | ‚úÖ | ‚ùå | ‚ùå |

---

## Estimated Fix Time

| Priority | Errors | Estimated Time |
|----------|--------|----------------|
| CRITICAL | 6 | 3-4 hours |
| HIGH | 6 | 4-5 hours |
| MEDIUM | 4 | 4-5 hours |
| LOW | 1 | 5 minutes |
| WARNING | 4 | Included in Critical/Medium |
| **TOTAL** | **21** | **12-14 hours** |

---

## Next Actions

1. **User to confirm** priorities and approach
2. **Begin with Critical** (Cells 78/80/83 - Excel files)
3. **Systematic fixes** following A-L protocol
4. **Document all fixes** in execution logs
5. **Test sequentially** from Cell 1 after each fix

---

**Status**: ERROR LOG COMPLETE
**Ready For**: Prioritized debugging with user approval
**Last Updated**: 2025-11-17
